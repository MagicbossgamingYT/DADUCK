<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chess Battle</title>
    <link rel="stylesheet" href="https://chessboardjs.com/dist/chessboard-1.0.0.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            text-align: center;
            padding: 20px;
        }
        .board {
            width: 90vw;
            max-width: 400px;
            margin: auto;
        }
        .info {
            margin-top: 20px;
        }
        .move-history {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 5px;
            background-color: white;
            text-align: left;
        }
        .message {
            color: red;
            margin-top: 10px;
        }
        .controls {
            margin: 20px 0;
        }
        #chat {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 5px;
            background-color: white;
            margin-top: 20px;
        }
        #chat-input {
            width: 80%;
        }
        #settings {
            display: none;
            background-color: white;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
        }
        .last-move {
            background-color: yellow;
        }
        button {
            cursor: pointer;
        }
        button:hover {
            background-color: #ddd;
        }
    </style>
</head>
<body>

<h1>AI Chess Battle</h1>
<div id="board" class="board"></div>
<br>
<div class="info">
    <div class="controls">
        <button id="reset" aria-label="Reset the game">Reset</button>
        <button id="settings-toggle" aria-label="Toggle settings">Settings</button>
        <button id="analyze" aria-label="Analyze the game">Analyze Game</button>
    </div>
    <div id="settings">
        <label for="ai-level">AI Level:</label>
        <select id="ai-level">
            <option value="easy">Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
        </select>
        <button id="apply-settings" aria-label="Apply selected settings">Apply Settings</button>
    </div>
    <div id="move-history" class="move-history"></div>
    <div class="message" id="message"></div>
    <div id="chat">
        <strong>Chat:</strong><br>
    </div>
    <input type="text" id="chat-input" placeholder="Type your message..." aria-label="Chat input">
    <button id="send-chat" aria-label="Send chat message">Send</button>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<script src="https://chessboardjs.com/dist/chessboard-1.0.0.min.js"></script>
<script>
    let board, game = new Chess();
    let isAIActive = true, aiLevel = 'easy';

    const pieceValues = {
        'p': 1,
        'r': 5,
        'n': 3,
        'b': 3,
        'q': 9,
        'k': 0
    };

    const evaluatePosition = () => {
        let totalValue = 0;
        game.board().forEach(row => {
            row.forEach(square => {
                if (square) {
                    totalValue += (square.color === 'w' ? 1 : -1) * pieceValues[square.type];
                }
            });
        });
        return totalValue;
    };

    const alphaBeta = (depth, game, alpha, beta, maximizingPlayer) => {
        if (depth === 0) return evaluatePosition();
        const legalMoves = game.ugly_moves();

        if (maximizingPlayer) {
            let maxEval = -Infinity;
            for (const move of legalMoves) {
                game.ugly_move(move);
                const eval = alphaBeta(depth - 1, game, alpha, beta, false);
                game.undo();
                maxEval = Math.max(maxEval, eval);
                alpha = Math.max(alpha, eval);
                if (beta <= alpha) break;
            }
            return maxEval;
        } else {
            let minEval = Infinity;
            for (const move of legalMoves) {
                game.ugly_move(move);
                const eval = alphaBeta(depth - 1, game, alpha, beta, true);
                game.undo();
                minEval = Math.min(minEval, eval);
                beta = Math.min(beta, eval);
                if (beta <= alpha) break;
            }
            return minEval;
        }
    };

    const getBestMove = () => {
        let bestMove = null;
        let bestValue = -Infinity;
        const depth = aiLevel === 'hard' ? 4 : aiLevel === 'medium' ? 3 : 2;

        for (const move of game.ugly_moves()) {
            game.ugly_move(move);
            const boardValue = alphaBeta(depth - 1, game, -Infinity, Infinity, false);
            game.undo();
            if (boardValue > bestValue) {
                bestValue = boardValue;
                bestMove = move;
            }
        }
        return bestMove;
    };

    const renderMoveHistory = (moves) => {
        $('#move-history').empty().append(moves.join(', '));
        highlightLastMove();
    };

    const highlightLastMove = () => {
        const history = game.history();
        if (history.length > 0) {
            const lastMove = history[history.length - 1];
            const from = lastMove.substring(0, 2);
            const to = lastMove.substring(2, 4);
            $('#' + from).addClass('last-move');
            $('#' + to).addClass('last-move');
            setTimeout(() => {
                $('#' + from).removeClass('last-move');
                $('#' + to).removeClass('last-move');
            }, 1000);
        }
    };

    const makeBestMove = () => {
        const bestMove = getBestMove();
        if (bestMove) {
            game.move(bestMove);
            board.position(game.fen());
            renderMoveHistory(game.history());
        }
    };

    const cfg = {
        draggable: true,
        position: 'start',
        onDrop: (source, target) => {
            const move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            renderMoveHistory(game.history());
            if (isAIActive) {
                setTimeout(makeBestMove, 500);
            }
        },
        onSnapEnd: () => {
            board.position(game.fen());
        },
    };

    $(document).ready(() => {
        board = ChessBoard('board', cfg);
        $('#reset').on('click', () => {
            game.reset();
            board.start();
            $('#move-history').empty();
            $('#message').text('');
        });

        $('#settings-toggle').on('click', () => {
            $('#settings').toggle();
        });

        $('#apply-settings').on('click', () => {
            aiLevel = $('#ai-level').val();
            $('#message').text('Settings applied!');
        });

        $('#send-chat').on('click', () => {
            const message = $('#chat-input').val();
            if (message) {
                $('#chat').append('<div>' + message + '</div>');
                $('#chat-input').val('');
            }
        });

        $('#message').text('Welcome to AI Chess Battle! Good luck!');
    });
</script>

</body>
</html>
