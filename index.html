<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Chess Application</title>
    <link rel="stylesheet" href="https://chessboardjs.com/dist/chessboard-1.0.0.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            text-align: center;
            padding: 20px;
        }
        .board {
            width: 90vw; /* Responsive width */
            max-width: 400px; /* Limit max width */
            margin: auto;
            border: 2px solid #333;
        }
        .info {
            margin-top: 20px;
            padding: 5px;
        }
        .move-history {
            margin-top: 10px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 5px;
            background-color: white;
        }
        .message {
            color: red;
            margin-top: 10px;
        }
        .last-move {
            background-color: rgba(0, 0, 255, 0.5);
        }
        .controls {
            margin: 20px 0;
        }
        .theme-selector {
            margin: 20px;
        }
        #chat {
            margin-top: 20px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 5px;
            background-color: white;
        }
        #chat-input {
            width: 80%;
        }
        #settings {
            display: none;
            background-color: white;
            border: 1px solid #ccc;
            padding: 10px;
        }
        .settings-input {
            margin-bottom: 10px;
        }
        .profile {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #fff;
        }
    </style>
</head>
<body>

<h1>Ultimate Chess Application</h1>
<div id="board" class="board"></div>
<br>
<div class="info">
    <div class="controls">
        <button id="reset">Reset</button>
        <button id="save">Save Game</button>
        <button id="load">Load Game</button>
        <button id="settings-toggle">Settings</button>
        <button id="analyze">Analyze Game</button>
    </div>
    <div id="settings">
        <div class="theme-selector">
            <label for="theme">Choose a theme:</label>
            <select id="theme">
                <option value="default">Default</option>
                <option value="dark">Dark</option>
                <option value="light">Light</option>
            </select>
        </div>
        <div class="settings-input">
            <label for="ai-level">AI Level:</label>
            <select id="ai-level">
                <option value="easy">Easy</option>
                <option value="medium">Medium</option>
                <option value="hard">Hard</option>
            </select>
        </div>
        <button id="apply-settings">Apply Settings</button>
    </div>
    <div id="move-history" class="move-history"></div>
    <div class="message" id="message"></div>
    <div class="profile" id="profile"></div>
    <div id="chat">
        <strong>Chat:</strong><br>
    </div>
    <input type="text" id="chat-input" placeholder="Type your message...">
    <button id="send-chat">Send</button>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<script src="https://chessboardjs.com/dist/chessboard-1.0.0.min.js"></script>
<script>
    var board,
        game = new Chess(),
        isAIActive = true,
        aiLevel = 'easy', // Default AI level
        userProfile = loadUserProfile() || { username: "Guest", history: [], rating: 1200 };

    // Piece values for evaluation
    var pieceValues = {
        'p': 1,
        'r': 5,
        'n': 3,
        'b': 3,
        'q': 9,
        'k': 0
    };

    // Opening book
    const openingBook = {
        'e4': ['e5', 'c5', 'e6'],
        'd4': ['d5', 'Nf6'],
        'Nf3': ['d5', 'c5', 'e5'], // New openings added
        'c4': ['e5', 'c6'],
    };

    // Function to evaluate the position based on material count
    function evaluatePosition() {
        var totalValue = 0;
        for (var rank = 0; rank < 8; rank++) {
            for (var file = 0; file < 8; file++) {
                var square = game.board()[rank][file];
                if (square) {
                    var pieceValue = pieceValues[square.type];
                    totalValue += square.color === 'w' ? pieceValue : -pieceValue;
                }
            }
        }
        return totalValue;
    }

    // Alpha-beta pruning algorithm
    function alphaBeta(depth, game, alpha, beta, maximizingPlayer) {
        if (depth === 0) {
            return evaluatePosition();
        }

        var legalMoves = game.ugly_moves();
        if (maximizingPlayer) {
            let maxEval = -Infinity;
            for (let move of legalMoves) {
                game.ugly_move(move);
                let eval = alphaBeta(depth - 1, game, alpha, beta, false);
                game.undo();
                maxEval = Math.max(maxEval, eval);
                alpha = Math.max(alpha, eval);
                if (beta <= alpha) {
                    break;
                }
            }
            return maxEval;
        } else {
            let minEval = Infinity;
            for (let move of legalMoves) {
                game.ugly_move(move);
                let eval = alphaBeta(depth - 1, game, alpha, beta, true);
                game.undo();
                minEval = Math.min(minEval, eval);
                beta = Math.min(beta, eval);
                if (beta <= alpha) {
                    break;
                }
            }
            return minEval;
        }
    }

    // Get the best move for the AI
    function getBestMove() {
        let bestMove = null;
        let bestValue = -Infinity;
        let depth = 3; // Set the search depth based on AI level

        // Adjust depth based on AI difficulty
        if (aiLevel === 'medium') {
            depth = 4;
        } else if (aiLevel === 'hard') {
            depth = 5;
        }

        for (let move of game.ugly_moves()) {
            game.ugly_move(move);
            let boardValue = alphaBeta(depth - 1, game, -Infinity, Infinity, false);
            game.undo();
            if (boardValue > bestValue) {
                bestValue = boardValue;
                bestMove = move;
            }
        }
        return bestMove;
    }

    // Get an opening move if available
    function getOpeningMove() {
        const history = game.history();
        if (history.length === 0) return null; // No moves yet
        const lastMove = history[history.length - 1];
        return openingBook[lastMove] ? openingBook[lastMove][Math.floor(Math.random() * openingBook[lastMove].length)] : null;
    }

    // Game analysis feature
    function analyzeGame() {
        const history = game.history();
        const analysis = [];
        for (let move of history) {
            game.move(move);
            let eval = evaluatePosition();
            if (eval < -2) { // Arbitrary threshold for blunder
                analysis.push(`Blunder on move ${move}: ${eval}`);
            }
            game.undo();
        }
        return analysis.length > 0 ? analysis.join('<br>') : 'No blunders detected.';
    }

    // Save user profile
    function saveUserProfile() {
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
    }

    // Load user profile
    function loadUserProfile() {
        const profile = localStorage.getItem('userProfile');
        return profile ? JSON.parse(profile) : { username: "Guest", history: [], rating: 1200 };
    }

    // Leaderboard management
    let leaderboard = [];

    function updateLeaderboard(username, score) {
        leaderboard.push({ username: username, score: score });
        leaderboard.sort((a, b) => b.score - a.score); // Sort by score descending
    }

    // Render leaderboard
    function renderLeaderboard() {
        let leaderboardHtml = '<strong>Leaderboard:</strong><br>';
        leaderboard.forEach((player, index) => {
            leaderboardHtml += `${index + 1}. ${player.username}: ${player.score}<br>`;
        });
        $('#leaderboard').html(leaderboardHtml);
    }

    // Initialize the chessboard
    const cfg = {
        draggable: true,
        position: 'start',
        onDrop: function(source, target) {
            const move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });

            if (move === null) return 'snapback';

            renderMoveHistory(game.history());
            highlightLastMove();
            if (isAIActive) {
                setTimeout(makeBestMove, 500);
            }
        },
        onSnapEnd: function() {
            board.position(game.fen());
            highlightLastMove();
        },
    };

    board = ChessBoard('board', cfg);

    $('#reset').on('click', function() {
        game.reset();
        board.start();
        $('#move-history').empty();
        $('#message').text('');
        clearHighlights();
        isAIActive = true; // Reset AI status
    });

    $('#save').on('click', function() {
        saveUserProfile();
        $('#message').text('Game saved!');
    });

    $('#load').on('click', function() {
        userProfile = loadUserProfile();
        $('#message').text('Profile loaded!');
    });

    $('#theme').on('change', function() {
        changeTheme(this.value);
    });

    $('#send-chat').on('click', function() {
        const message = $('#chat-input').val();
        if (message) {
            $('#chat').append('<div>' + message + '</div>');
            $('#chat-input').val('');
        }
    });

    $('#settings-toggle').on('click', function() {
        $('#settings').toggle();
    });

    $('#apply-settings').on('click', function() {
        aiLevel = $('#ai-level').val();
        $('#message').text('Settings applied!');
    });

    $('#analyze').on('click', function() {
        const analysisResult = analyzeGame();
        $('#message').html(analysisResult);
    });

    // Highlight the last move
    function highlightLastMove() {
        const history = game.history();
        if (history.length > 0) {
            const lastMove = history[history.length - 1];
            const from = lastMove.substring(0, 2);
            const to = lastMove.substring(2, 4);
            $('#' + from).addClass('last-move');
            $('#' + to).addClass('last-move');
            setTimeout(function() {
                $('#' + from).removeClass('last-move');
                $('#' + to).removeClass('last-move');
            }, 1000);
        }
    }

    // Render move history
    function renderMoveHistory(moves) {
        const historyElement = $('#move-history').empty();
        historyElement.append(moves.join(', '));
    }

    // Clear highlights on the board
    function clearHighlights() {
        $('.valid-move').removeClass('valid-move');
    }

    // Make the best move for the AI
    function makeBestMove() {
        const bestMove = getBestMove() || getOpeningMove();
        if (bestMove) {
            game.move(bestMove);
            board.position(game.fen());
            renderMoveHistory(game.history());
        }
    }

    // Initialize default theme
    function changeTheme(theme) {
        if (theme === 'dark') {
            $('body').css('background-color', '#333').css('color', '#fff');
        } else {
            $('body').css('background-color', '#f5f5f5').css('color', '#000');
        }
    }

    // Load user profile on startup
    $(document).ready(function() {
        const userProfile = loadUserProfile();
        if (userProfile) {
            $('#message').text(`Welcome back, ${userProfile.username}!`);
            $('#profile').text(`Profile: ${userProfile.username}, Rating: ${userProfile.rating}`);
        }
        renderLeaderboard();
    });

    // Request permission for notifications
    Notification.requestPermission();
</script>

</body>
</html>
